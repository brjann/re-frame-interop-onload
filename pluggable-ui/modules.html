<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>BASS4 ui demo</title>
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="menu"></div>
<div id="main"></div>
<script src="/js/jquery/jquery-3.2.0.min.js" type="text/javascript"></script>
<script src="/assets/bootstrap/js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script src="ui.js" type="text/javascript"></script>
<script type="text/javascript">
   let content_last_updated = function (content) {
      if (content['data-updated']) {
         return 'Last edited: ' + new Date(content['data-updated']).toDateString();
      }
      return '';
   };
   let content_accessed = function (content) {
      if (!content['accessed?']) {
         return 'NEW!';
      }
      return '';
   };

   let key_exercise = function (content) {
      if (content['tags'].indexOf('key') >= 0) {
         return '<strong>KEY EXERCISE</strong>&nbsp;';
      } else {
         return '';
      }

   };

   let activate_module = function (module_id) {
      console.log('Activating module');
      $.ajax('/api/user/tx/activate-module',
         {
            method: 'put',
            data: JSON.stringify({'module-id': module_id}),
            contentType: 'application/json',
            success: function () {
               console.log('Module activated');
               alert('Module has been activated!');
            }
         }
      )
   };

   let load_modules = function ($modules_div) {
      console.log('Fetching modules');
      $.ajax('/api/user/tx/modules', {
         success: function (data) {
            console.log('Modules fetched');
            $.map(data, function (m) {
               $modules_div.append('<h2>' + m['module-name'] + '</h2');
               if (!m['active?']) {
                  let $activate_btn = $('<button>Give me access!</button>').click(function () {
                     activate_module(m['module-id']);
                  });
                  $('<p><em>Not available</em>&nbsp;</p>')
                     .append($activate_btn)
                     .appendTo($modules_div);
               } else {
                  $modules_div.append('<small>Available ' + new Date(m['activation-date']).toDateString() + '</small>');
                  if (m['main-text']) {
                     $modules_div.append('<p><a href="module-main.html?module-id=' + m['module-id'] + '">' +
                        'Read module text</a>&nbsp;' + content_last_updated(m['main-text'])
                        + '&nbsp;' + key_exercise(m['main-text']) + content_accessed(m['main-text']) +
                        '</p>')
                  }
                  $.map(m['worksheets'], function (w) {
                     $modules_div.append('<p>' +
                        '<a href="module-worksheet.html?module-id=' + m['module-id'] + '&worksheet-id=' + w['content-id'] + '">' +
                        'Fill in worksheet ' + w['content-name'] +
                        '</a>&nbsp;' + key_exercise(w) + content_last_updated(w) + '&nbsp;' + content_accessed(w) +
                        '</p>')
                  });
                  if (m['homework']) {
                     var status;
                     if (m['homework-status'] === 'submitted') {
                        status = 'Submitted';
                     } else if (m['homework-status'] === 'ok') {
                        status = 'Completed';
                     } else {
                        status = content_last_updated(m['homework']) + '&nbsp;'
                     }
                     $modules_div.append('<p>' +
                        '<a href="module-homework.html?module-id=' + m['module-id'] + '">' +
                        'Complete module homework</a>&nbsp;' + status + key_exercise(m['homework']) +
                        '&nbsp;' + content_accessed(m['homework']) +
                        '</p>')
                  }
               }
            })
         }
      });
   };

   $(document).ready(function () {
      $.when(init_page()).done(function () {
         let $main_div = $('#main');
         let $modules_div = $('<div></div>').appendTo($main_div);
         load_modules($modules_div);
      });
   });
</script>
</body>
</html>
