<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>BASS4 ui demo</title>
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="menu"></div>
<div id="main"></div>
<script src="/js/jquery/jquery-3.2.0.min.js" type="text/javascript"></script>
<script src="/assets/bootstrap/js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script src="sprintf.js"></script>
<script src="showdown.min.js"></script>
<script src="underscore-min.js" type="text/javascript"></script>
<script src="js.cookie.js" type="text/javascript"></script>
<script src="ui.js" type="text/javascript"></script>
<script src="content.js" type="text/javascript"></script>
<script type="text/javascript">

   let load_content = function ($content_div, module_id) {
      console.log('Fetching homework');
      $.ajax('/api/user/tx/module-homework/' + module_id,
         {
            success: function (homework) {
               let readonly = homework['status'] === 'ok' || homework['status'] === 'submitted',
                  $content = content_handler(module_id, homework, readonly);

               if (homework['status'] === 'ok') {
                  $content.prepend('<p><strong>Your homework has been reviewed by your therapist.</strong></p>')
               } else if (homework['status'] === 'submitted') {
                  $content.prepend('<p><strong>You have submitted your homework and it is waiting to be reviewed by your therapist.</strong></p>')
               }

               let $save_button = $content.find('#save-button');
               if ($save_button.length > 0) {
                  $save_button.text('Save without submitting');
                  $('<button>Submit homework</button>')
                     .insertBefore($save_button)
                     .click(function () {
                        console.log('Submitting homework');
                        $.ajax('/api/user/tx/module-homework-submit',
                           {
                              method: 'put',
                              contentType: 'application/json',
                              data: JSON.stringify(
                                 {
                                    'module-id': module_id
                                 }),
                              success: function () {
                                 console.log('Homework submitted')
                              }
                           });
                        $save_button.click();
                     });
               }
               $content_div.append($content);
            }
         })
   };

   $(document).ready(function () {
      $.when(init_page()).done(function () {
         let $main_div = $('#main');
         let $content_div = $('<div></div>').appendTo($main_div);
         let module_id = parseInt(getParameterByName('module-id', window.location.href));
         load_content($content_div, module_id);
      });
   });
</script>
</body>
</html>
