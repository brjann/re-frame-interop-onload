<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>BASS4 ui demo</title>
    <link href="/assets/bootstrap/css/bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="/assets/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="menu"></div>
<div id="main"></div>
<script src="/js/jquery/jquery-3.2.0.min.js" type="text/javascript"></script>
<script src="/assets/bootstrap/js/bootstrap.bundle.min.js" type="text/javascript"></script>
<script src="ui.js" type="text/javascript"></script>
<script type="text/javascript">
   let load_messages = function ($message_div) {
      console.log('Fetching messages');
      $.ajax('/api/user/tx/messages', {
         success: function (data) {
            console.log('Messages fetched');
            let unreads = [];
            $.map(data, function (m) {
               let message = m['message'].replace(/(?:\r\n|\r|\n)/g, '<br>');
               let sender = (m['sender-type'] === 'therapist') ? m['sender-name'] : 'me';
               let time = new Date(m['send-datetime']).toDateString();
               let unread = m['unread?'];
               if (unread && sender !== "me") {
                  message = '<strong>' + message + '</strong>';
               }
               $message_div.append('<p>From: ' + sender + ' on ' + time + '</p>');
               $message_div.append('<p><em>' + message + '</em></p>');
               $message_div.append('<hr>');
               if (unread) {
                  unreads.push(m['message-id']);
               }
            });

            // Notify that all unread messages are now read
            $.map(unreads, function (id) {
               console.log('Marking message ' + id + ' as read');
               $.ajax('/api/user/tx/message-read', {
                     method: 'post',
                     data: JSON.stringify({'message-id': id}),
                     contentType: 'application/json'
                  }
               );
            })
         }
      });
   };

   $(document).ready(function () {
      $.when(init_page()).done(function () {
         let $main_div = $('#main');
         let $message_div = $('<div></div>').appendTo($main_div);
         load_messages($message_div);
         if (treatment_info['send-messages?']) {
            let $message_div = $('#main');
            $message_div.append('<div><form method="POST" action="/api/user/tx/message" id="message-form">' +
               '<p><b>New Message</b></p>' +
               '<textarea name="message" cols="50" rows="5"></textarea>' +
               '<input type="submit" value="Send message">' +
               '</form>' +
               '</div>'
            )
         }
         $('#message-form').submit(form_json_submit);
      });
   });
</script>
</body>
</html>
