{% extends "simple.html" %}
{% block content %}

<h1>BankID status</h1>
<div class="alert alert-primary" role="alert">
    <p>Status: <span id="status"></span></p>
    <p>Hint code: <span id="hint-code"></span></p>
    <p>Personnummer: <span id="personnummer"></span></p>
    <p>Name: <span id="name"></span></p>
    <p>Error: <span id="error"></span></p>
    <p>Loads: <span id="load-counter">0</span></p>
</div>

<script type="application/javascript">
   $(document).ready(function () {
      var $status = $('#status');
      var $hint_code = $('#hint-code');
      var $personnummer = $('#personnummer');
      var $name = $('#name');
      var $error = $('#error');
      var $load_counter = $('#load-counter');
      var interval;

      var success_fn = function (data) {
         console.log(data);
         var status = data['status'];
         $status.text(data['status']);
         $hint_code.text(data['hint-code']);
         $personnummer.text(data['personnummer']);
         $name.text(data['name']);
         $error.text(data['error']);

         if ($.inArray(status, ['complete', 'failed', 'error']) > -1) {
            clearInterval(interval);
         }
      };

      var error_fn = function (jqXHR) {
         $status.text('ERROR');
         $hint_code.text(jqXHR.status);
         clearInterval(interval);
      };

      var collect_status = function () {
         $load_counter.text((parseInt($load_counter.text()) || 0) + 1);
         $.ajax(
            "/e-auth/bankid-collect",
            {
               method: "post",
               success: success_fn,
               error: error_fn
            }
         );
      };
      interval = setInterval(collect_status, 1000)
   })
</script>

{% endblock %}
